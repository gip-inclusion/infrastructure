name: "{{ workflow_name }}"

permissions:
  contents: read
  id-token: write

on:
  {{ event_type }}:
    branches:
      - main
    paths:
      - {{ project_path }}/*.tfvars
      - {{ project_path }}/**/*.tf
      - {{ project_path }}/*.tf
      - {{ project_path }}/.terraform.lock.hcl

jobs:
  {{ job_name }}:
    env:
      SCW_ACCESS_KEY: {% raw %}${{ secrets.SCW_TF_CI_ACCESS_KEY }}{% endraw %}
      SCW_SECRET_KEY: {% raw %}${{ secrets.SCW_TF_CI_SECRET_KEY }}{% endraw %}
      SCW_PROJECT_ID: {% raw %}${{ secrets.SCW_DEFAULT_PROJECT_ID }}{% endraw %}
      SCW_ORGANIZATION_ID: {% raw %}${{ secrets.SCW_ORGANIZATION_ID }}{% endraw %}
      # ⬇ This one (legacy) seems still required by some modules…
      SCW_DEFAULT_ORGANIZATION_ID: {% raw %}${{ secrets.SCW_ORGANIZATION_ID }}{% endraw %}
      AWS_ACCESS_KEY_ID: {% raw %}${{ secrets.SCW_TF_CI_ACCESS_KEY }}{% endraw %}
      AWS_SECRET_ACCESS_KEY: {% raw %}${{ secrets.SCW_TF_CI_SECRET_KEY }}{% endraw %}
      PROJECT_PATH: "{{ project_path }}"
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup tfswitch
        uses: stv-io/action-tfswitch@01899697517eba6caeb47aec23e60cc4c80313df # v1.0.2

      - name: Terraform validate
        id: tf-validate
        working-directory: {% raw %}${{ env.PROJECT_PATH }}{% endraw %}
        run: |
          tfswitch
          terraform init -input=false
          terraform validate -no-color

      - name: Terraform plan
        id: tf-plan
        working-directory: {% raw %}${{ env.PROJECT_PATH }}{% endraw %}
        run: |
          tfswitch
          terraform plan -lock-timeout=60s -var-file=terraform.tfvars -input=false
{% if target == 'main' %}
      - name: Terraform apply
        id: tf-apply
        working-directory: {% raw %}${{ env.PROJECT_PATH }}{% endraw %}
        run: |
          tfswitch
          terraform apply -input=false -auto-approve
{% endif %}
